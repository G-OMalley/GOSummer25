import pandas as pd
import numpy as np
from pathlib import Path
from datetime import datetime, timedelta
import json
import webbrowser
import time

# --- Setup ---
# Determine the base directory of the script
script_dir = Path(__file__).parent

# The project root (e.g., 'trader-helper') is one level up from the script's directory.
project_root = script_dir.parent

# Define the base data folder relative to the project root
# This assumes your 'INFO' folder is directly under the 'trader-helper' root
data_folder = project_root / "INFO"

# Define the output path for the generated HTML report relative to the project root
# This assumes the HTML report should be generated directly in the 'trader-helper' root
output_path = project_root / "EIA_Report.html"

print(f"Data folder resolved to: {data_folder}")
print(f"Output path resolved to: {output_path}")

region_map = {
    "Lower 48 States Storage (Bcf)": "lower_48_states_storage",
    "East Region Storage (Bcf)": "east_region_storage",
    "Midwest Region Storage (Bcf)": "midwest_region_storage",
    "South Central Region Storage (Bcf)": "south_central_region_storage",
    "Salt Region SC Storage (Bcf)": "salt_region_sc_storage",
    "Nonsalt Region SC Storage (Bcf)": "nonsalt_region_sc_storage",
    "Mountain Region Storage (Bcf)": "mountain_region_storage",
    "Pacific Region Storage (Bcf)": "pacific_region_storage"
}
# DEFAULT_REGION_DISPLAY_NAME is now used as the fixed default for the Report tab.
DEFAULT_REGION_DISPLAY_NAME = "Lower 48 States Storage (Bcf)"

files = {
    "eia_totals": "EIAtotals.csv",
    "eia_changes": "EIAchanges.csv",
    "weather": "WEATHER.csv",
    "prices": "PRICES.csv",
    "fundy": "Fundy.csv",
    "forecast": "FundyForecast.csv",
    "criterion_storage_change": "CriterionStorageChange.csv",
    "nuclear_forecast": "NuclearForecast.csv", # Add the new file
}

# --- Data Loading and Cleaning ---
def load_clean_df(file_key, fname, data_path):
    fpath = data_path / fname
    if not fpath.exists():
        print(f"‚ùå Error: Required file '{fname}' not found at {fpath}. Skipping this file.")
        # Return None or an empty DataFrame to allow the script to continue without crashing
        return None 
    df = pd.read_csv(fpath)

    # Specific cleaning for each file type to ensure correct column names
    if file_key in ["eia_totals", "eia_changes"]:
        df.columns = df.columns.str.lower().str.replace(" (bcf)", "", regex=False).str.replace(" ", "_").str.replace(":", "").str.strip()
        if "period" in df.columns:
            df["period"] = pd.to_datetime(df["period"], errors="coerce")
    elif file_key == "weather":
        df.columns = df.columns.str.strip()
        if 'Date' in df.columns:
            df = df.rename(columns={'Date': 'date'})
            df['date'] = pd.to_datetime(df['date'], errors='coerce')
        if 'City Title' in df.columns:
            df = df.rename(columns={'City Title': 'city_title'})
        if 'Avg Temp' in df.columns:
            df = df.rename(columns={'Avg Temp': 'avg_temp'})
        if 'avg_temp' in df.columns:
            df['avg_temp'] = pd.to_numeric(df['avg_temp'], errors='coerce')
    elif file_key == "prices":
        df.columns = df.columns.str.strip()
        if 'Date' in df.columns:
            df = df.rename(columns={'Date': 'date'})
            df['date'] = pd.to_datetime(df['date'], errors='coerce')

        henry_col_found = False
        potential_henry_cols = [col for col in df.columns if 'Henry Hub' in col or 'Henry' == col]
        if 'Henry' in potential_henry_cols:
            df = df.rename(columns={'Henry': 'henry'})
            henry_col_found = True
        elif potential_henry_cols:
            df = df.rename(columns={potential_henry_cols[0]: 'henry'})
            henry_col_found = True

        if henry_col_found:
            df['henry'] = pd.to_numeric(df['henry'], errors='coerce')
    elif file_key in ["fundy", "forecast"]:
        df.columns = df.columns.str.strip()
        if 'Date' in df.columns:
            df['Date'] = pd.to_datetime(df['Date'], errors="coerce")
    # New cleaning for criterion_storage_change
    elif file_key == "criterion_storage_change":
        df.columns = df.columns.str.strip()
        if 'eff_gas_day' in df.columns:
            df['eff_gas_day'] = pd.to_datetime(df['eff_gas_day'], errors="coerce")
        if 'daily_storage_change' in df.columns:
            df['daily_storage_change'] = pd.to_numeric(df['daily_storage_change'], errors="coerce")
    # New cleaning for nuclear_forecast
    elif file_key == "nuclear_forecast":
        df.columns = df.columns.str.strip()
        if 'Date' in df.columns:
            df = df.rename(columns={'Date': 'date'})
            df['date'] = pd.to_datetime(df['date'], errors="coerce")
        if 'value' in df.columns:
            df = df.rename(columns={'value': 'mw_generated'}) # Rename 'value' to 'mw_generated' for clarity
            df['mw_generated'] = pd.to_numeric(df['mw_generated'], errors="coerce")
    return df

raw_data = {key: load_clean_df(key, fname, data_folder) for key, fname in files.items()}
raw_data = {k: v for k, v in raw_data.items() if v is not None} # Filter out missing files


# --- DIAGNOSTIC PRINT FOR EIA_TOTALS COLUMNS (kept as it's a structural check) ---
print("\n--- Diagnostic: Cleaned columns in EIAtotals.csv ---")
if "eia_totals" in raw_data:
    print(raw_data["eia_totals"].columns.tolist())
else:
    print("EIAtotals.csv was not loaded.")
print("---------------------------------------------------\n")

# --- Region Data Processing ---
def process_region_data(display_name, internal_column_name, raw_data):
    try:
        price_col_name = 'henry' if 'prices' in raw_data and 'henry' in raw_data["prices"].columns else None
            
        prices_weekly = pd.DataFrame()
        if price_col_name and 'prices' in raw_data and not raw_data["prices"].empty:
            prices_weekly = raw_data["prices"].set_index("date").resample("W-FRI")[price_col_name].mean().ffill().reset_index().rename(columns={price_col_name: "weekly_avg_price", "date": "period"})
            prices_weekly.dropna(subset=["weekly_avg_price"], inplace=True)

        merged = pd.DataFrame() # Initialize empty DataFrame
        if "eia_totals" in raw_data and "eia_changes" in raw_data:
            merged = pd.merge(raw_data["eia_totals"], raw_data["eia_changes"], on="period", how="outer")
            if not prices_weekly.empty: merged = merged.merge(prices_weekly, on="period", how="outer")
            merged = merged.sort_values("period")
        else:
            print(f"‚ö†Ô∏è Warning: 'eia_totals' or 'eia_changes' data not found. Skipping region data processing for {display_name}.")
            return None # Cannot proceed without core EIA data

        # --- Check if the internal_column_name exists in the merged DataFrame ---
        if internal_column_name not in merged.columns:
            print(f"‚ùå Error processing region {display_name}: Required storage column '{internal_column_name}' not found in merged data.")
            return None

        df_for_latest = merged.dropna(subset=[internal_column_name])
        if "weekly_avg_price" in df_for_latest.columns:
            df_for_latest = df_for_latest.dropna(subset=["weekly_avg_price"])

        if df_for_latest.empty:
            return None

        latest_valid_row_series = df_for_latest.iloc[-1]

        latest_date = latest_valid_row_series["period"].date()
        latest_price = round(latest_valid_row_series["weekly_avg_price"], 2) \
                                    if pd.notna(latest_valid_row_series.get("weekly_avg_price")) else "N/A"
        
        # --- Storage Position Calculation for Report Tab ---
        current_storage = "N/A"
        five_year_avg = "N/A"
        storage_position_bcf = "N/A"
        storage_position_label = "N/A"

        latest_bcf_value = latest_valid_row_series.get(internal_column_name)
        
        if pd.notna(latest_bcf_value):
            current_storage = round(latest_bcf_value, 1)

            current_week = latest_valid_row_series["period"].isocalendar().week
            
            historical_data_for_week = merged[
                (merged["period"].dt.isocalendar().week == current_week) &
                (merged["period"].dt.year < datetime.now().year)
            ]
            
            min_years_for_avg = 5 
            num_historical_years = historical_data_for_week["period"].dt.year.nunique()

            if num_historical_years >= min_years_for_avg: 
                mean_bcf_for_week = historical_data_for_week[internal_column_name].mean()
                
                if pd.notna(mean_bcf_for_week):
                    five_year_avg = round(mean_bcf_for_week, 1)
                    
                    storage_position_bcf_val = current_storage - five_year_avg
                    storage_position_bcf = round(storage_position_bcf_val, 1)

                    if storage_position_bcf_val > 0:
                        storage_position_label = f"üü¢ Surplus: +{storage_position_bcf:,.1f} Bcf (Bearish)"
                    elif storage_position_bcf_val < 0:
                        storage_position_label = f"üî¥ Deficit: {storage_position_bcf:,.1f} Bcf (Bullish)"
                    else:
                        storage_position_label = f"‚ö™ In Line: {storage_position_bcf:,.1f} Bcf"
            else:
                storage_position_label = f"Insufficient historical data (< {min_years_for_avg} years) for 5-Year Avg"

        # Graph Data & Momentum calculations
        graph_cols = ["period", internal_column_name]
        if "weekly_avg_price" in merged.columns: graph_cols.append("weekly_avg_price") 

        graph_df = merged[graph_cols].dropna(subset=["period", internal_column_name]).rename(columns={"period": "Date", internal_column_name: "Bcf"})
        graph_df["Week"], graph_df["Year"] = graph_df["Date"].dt.isocalendar().week.astype(int), graph_df["Date"].dt.year
        graph_df = graph_df[graph_df["Year"] >= 2015]

        chart_map = {i: {"Week": i} for i in range(1, 54)}
        for week, row in graph_df[graph_df["Year"] < datetime.now().year].groupby("Week")["Bcf"].agg(["min", "max", "mean"]).iterrows():
            if week in chart_map: chart_map[int(week)].update({"min": float(row["min"]), "max": float(row["max"]), "mean": float(row["mean"])})

        current_year_for_chart = datetime.now().year

        for year in graph_df["Year"].unique():
            for _, row in graph_df[graph_df["Year"] == year].iterrows():
                if row["Week"] in chart_map:
                    chart_map[row["Week"]].setdefault(f"year_{year}", float(row["Bcf"]))
                    if pd.notna(row.get("weekly_avg_price")):
                        chart_map[row["Week"]].setdefault("price", float(row["weekly_avg_price"]))
                    
                    if year == current_year_for_chart:
                        chart_map[row["Week"]]["Bcf"] = float(row["Bcf"])
                        if pd.notna(row.get("weekly_avg_price")):
                            chart_map[row["Week"]]["price"] = float(row["weekly_avg_price"])


        graph_data_list = sorted([chart_map.get(i, {"Week": i}) for i in range(1, 54)], key=lambda x: x["Week"])

        # --- LOGARITHMIC REGRESSION CALCULATION ---
        log_fit_data = []
        
        fit_df = merged.dropna(subset=[internal_column_name, 'weekly_avg_price']).copy()
        fit_df = fit_df[fit_df[internal_column_name] > 0]

        if not fit_df.empty and len(fit_df) >= 2:
            x_fit = fit_df[internal_column_name].astype(float)
            y_fit = fit_df['weekly_avg_price'].astype(float)

            try:
                coefficients = np.polyfit(np.log(x_fit), y_fit, 1)
                a = coefficients[0]
                b = coefficients[1]

                x_min_fit = x_fit.min()
                x_max_fit = x_fit.max()
                
                x_values_for_line = np.linspace(x_min_fit, x_max_fit, 100)
                
                y_values_for_line = a * np.log(x_values_for_line) + b

                for i in range(len(x_values_for_line)):
                    log_fit_data.append({"x": round(x_values_for_line[i], 2), "y": round(y_values_for_line[i], 2)})
            except Exception as e:
                log_fit_data = []

        return {
            "report": {
                "latest_date": str(latest_date),
                "latest_price": latest_price,
                "current_storage": current_storage, 
                "five_year_avg": five_year_avg,     
                "storage_position_bcf": storage_position_bcf, 
                "storage_position_label": storage_position_label 
            },
            "graph": graph_data_list,
            "log_fit": log_fit_data
        }
    except Exception as e:
        print(f"‚ùå Error processing region {display_name}: {e}")
        return None

# --- Precompute Data ---
region_outputs = {d_name: process_region_data(d_name, i_col_name, raw_data) for d_name, i_col_name in region_map.items()}
region_outputs = {k: v for k, v in region_outputs.items() if v is not None} # Filter out failed regions

# --- Extract the EIA report date for weather alignment ---
# This is derived from the latest EIA storage data for the default region
default_eia_report_date_str = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("latest_date", "N/A")

eia_report_date = None
if default_eia_report_date_str != "N/A":
    try:
        eia_report_date = datetime.strptime(default_eia_report_date_str, "%Y-%m-%d").date()
    except ValueError:
        print(f"‚ö†Ô∏è Warning: Could not parse EIA report date '{default_eia_report_date_str}' for weather alignment.")

# --- Recent US Temperature, CDD, and HDD Calculations (Aligned to EIA Report Date) ---
avg_temp = "N/A"
avg_cdd = "N/A"
avg_hdd = "N/A"
BASE_TEMP_CDD_HDD = 65 # Standard base temperature for CDD/HDD in natural gas markets

weather_df_copy = raw_data.get("weather")

if weather_df_copy is not None and not weather_df_copy.empty:
    required_weather_cols = ['date', 'city_title', 'avg_temp']
    if all(col in weather_df_copy.columns for col in required_weather_cols):
        if eia_report_date and not weather_df_copy.empty:
            # Filter weather data up to and including the EIA report date
            weather_data_up_to_eia_date = weather_df_copy[weather_df_copy["date"].dt.date <= eia_report_date].copy()

            if not weather_data_up_to_eia_date.empty:
                # Find the actual latest date available in the weather data that is <= EIA report date
                latest_relevant_weather_date = weather_data_up_to_eia_date["date"].max()
                
                # Define the 7-day period ending on this latest relevant weather date
                one_week_ago = latest_relevant_weather_date - timedelta(days=6)
                recent_week_df = weather_data_up_to_eia_date[
                    (weather_data_up_to_eia_date["date"] >= one_week_ago) & 
                    (weather_data_up_to_eia_date["date"] <= latest_relevant_weather_date)
                ].copy()

                recent_week_df.dropna(subset=['avg_temp'], inplace=True)

                if not recent_week_df.empty:
                    # Calculate average 'avg_temp' for each city for the past 7 days
                    city_avg_temps_series = recent_week_df.groupby('city_title')['avg_temp'].mean()
                    
                    if not city_avg_temps_series.empty:
                        avg_temp = round(city_avg_temps_series.mean(), 1) # Overall average for dashboard

                        # Calculate CDD and HDD for each city and then average across cities
                        recent_week_df['cdd'] = (recent_week_df['avg_temp'] - BASE_TEMP_CDD_HDD).apply(lambda x: max(0, x))
                        recent_week_df['hdd'] = (BASE_TEMP_CDD_HDD - recent_week_df['avg_temp']).apply(lambda x: max(0, x))
                        
                        # Average CDD and HDD across all cities for the 7-day period
                        city_avg_cdd_series = recent_week_df.groupby('city_title')['cdd'].mean()
                        city_avg_hdd_series = recent_week_df.groupby('city_title')['hdd'].mean()

                        if not city_avg_cdd_series.empty:
                            avg_cdd = round(city_avg_cdd_series.mean(), 1)
                        if not city_avg_hdd_series.empty:
                            avg_hdd = round(city_avg_hdd_series.mean(), 1)
    else:
        print(f"‚ö†Ô∏è Warning: Missing required columns in 'WEATHER.csv'. Expected: {required_weather_cols}. Actual: {weather_df_copy.columns.tolist()}")
else:
    print("‚ö†Ô∏è Warning: 'WEATHER.csv' data not found or is empty. Skipping weather calculations.")


# --- Fundy Data Processing (for Balance Trends tab) ---
fundy_df = raw_data.get("fundy")
forecast_df = raw_data.get("forecast")

fundy_chart_data = {"labels": [], "values": []}
forecast_chart_data = {"labels": [], "values": []}

if fundy_df is not None and not fundy_df.empty and "item" in fundy_df.columns and "Date" in fundy_df.columns:
    fundy_df_filtered = fundy_df[fundy_df["item"] == "CONUS - Balance"].sort_values("Date")
    fundy_chart_data = {
        "labels": fundy_df_filtered["Date"].dt.strftime("%Y-%m-%d").tolist(),
        "values": fundy_df_filtered["value"].round(2).tolist(),
    }
else:
    print("‚ö†Ô∏è Warning: 'Fundy.csv' data not found, empty, or missing required columns. Skipping historical balance data.")

if forecast_df is not None and not forecast_df.empty and "item" in forecast_df.columns and "Date" in forecast_df.columns:
    forecast_df_filtered = forecast_df[forecast_df["item"] == "CONUS - Balance"].sort_values("Date")
    forecast_chart_data = {
        "labels": forecast_df_filtered["Date"].dt.strftime("%Y-%m-%d").tolist(),
        "values": forecast_df_filtered["value"].round(2).tolist(),
    }
else:
    print("‚ö†Ô∏è Warning: 'FundyForecast.csv' data not found, empty, or missing required columns. Skipping forecast balance data.")


# --- Daily Storage Change Data Processing ---
criterion_df = raw_data.get("criterion_storage_change")
daily_change_chart_data = {}

if criterion_df is not None and not criterion_df.empty:
    # Ensure correct column names before grouping
    if 'storage_name' in criterion_df.columns and 'eff_gas_day' in criterion_df.columns and 'daily_storage_change' in criterion_df.columns:
        for storage_name, group_df in criterion_df.groupby('storage_name'):
            # Sort by date to ensure correct line plotting
            group_df = group_df.sort_values('eff_gas_day')
            daily_change_chart_data[storage_name] = {
                "dates": group_df["eff_gas_day"].dt.strftime("%Y-%m-%d").tolist(),
                "values": group_df["daily_storage_change"].round(2).tolist()
            }
        print("Daily change data processed for storage names:", daily_change_chart_data.keys())
    else:
        print(f"‚ö†Ô∏è Warning: Missing required columns in 'CriterionStorageChange.csv'. Expected: ['storage_name', 'eff_gas_day', 'daily_storage_change']. Actual: {criterion_df.columns.tolist()}")
else:
    print("‚ö†Ô∏è Warning: 'CriterionStorageChange.csv' data not found or is empty. Daily changes chart will not be available.")

# --- Nuclear Generation Data Processing ---
nuclear_df = raw_data.get("nuclear_forecast")
nuclear_generation_chart_data = {"labels": [], "mw_values": [], "price_values": []}

if nuclear_df is not None and not nuclear_df.empty:
    required_nuclear_cols = ['date', 'mw_generated']
    if all(col in nuclear_df.columns for col in required_nuclear_cols):
        # Aggregate total MW generated by date
        daily_nuclear_mw = nuclear_df.groupby('date')['mw_generated'].sum().reset_index()
        daily_nuclear_mw.rename(columns={'mw_generated': 'total_mw_generated'}, inplace=True)
        
        # Merge with Henry Hub prices
        prices_df = raw_data.get("prices")
        if prices_df is not None and not prices_df.empty and 'date' in prices_df.columns and 'henry' in prices_df.columns:
            # Resample Henry Hub prices to daily average if needed, and ensure 'date' column for merging
            # Using 'D' for daily frequency and 'mean' for aggregation
            prices_daily = prices_df.set_index("date")['henry'].resample("D").mean().ffill().reset_index()
            
            # Perform a left merge to keep all nuclear dates and add corresponding Henry Hub prices
            merged_nuclear_price = pd.merge(daily_nuclear_mw, prices_daily, on='date', how='left')
            merged_nuclear_price.dropna(subset=['total_mw_generated'], inplace=True) # Ensure we have nuclear data
            
            nuclear_generation_chart_data = {
                "labels": merged_nuclear_price["date"].dt.strftime("%Y-%m-%d").tolist(),
                "mw_values": merged_nuclear_price["total_mw_generated"].round(2).tolist(),
                "price_values": merged_nuclear_price["henry"].round(2).tolist()
            }
            print("Nuclear generation data processed and merged with Henry Hub prices.")
        else:
            print("‚ö†Ô∏è Warning: Henry Hub price data not available or missing required columns for merging with nuclear generation. Nuclear chart will display only MW values.")
            nuclear_generation_chart_data = {
                "labels": daily_nuclear_mw["date"].dt.strftime("%Y-%m-%d").tolist(),
                "mw_values": daily_nuclear_mw["total_mw_generated"].round(2).tolist(),
                "price_values": [None] * len(daily_nuclear_mw) # Fill with None if no price data
            }
    else:
        print(f"‚ö†Ô∏è Warning: Missing required columns in 'NuclearForecast.csv'. Expected: {required_nuclear_cols}. Actual: {nuclear_df.columns.tolist()}")
else:
    print("‚ö†Ô∏è Warning: 'NuclearForecast.csv' data not found or is empty. Nuclear generation chart will not be available.")


# --- Extract Report Data for Initial HTML Render ---
# These are now just placeholders to ensure the f-string formatting works on initial load.
# The actual content is filled by JS updateReportContent.
report_latest_date = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("latest_date", "N/A")
report_latest_price = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("latest_price", "N/A")
report_current_storage = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("current_storage", "N/A")
report_five_year_avg = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("five_year_avg", "N/A")
report_storage_position_label = region_outputs.get(DEFAULT_REGION_DISPLAY_NAME, {}).get("report", {}).get("storage_position_label", "N/A")


# --- HTML Components ---
region_options_html = ''.join([f'<option value="{r}"{" selected" if r == DEFAULT_REGION_DISPLAY_NAME else ""}>{r}</option>' for r in region_outputs.keys()])
storage_name_options_html = ''.join([f'<option value="{name}">{name}</option>' for name in sorted(daily_change_chart_data.keys())])


region_outputs_json = json.dumps(region_outputs, default=str)
fundy_chart_data_json = json.dumps(fundy_chart_data)
forecast_chart_data_json = json.dumps(forecast_chart_data)
daily_change_chart_data_json = json.dumps(daily_change_chart_data)
nuclear_generation_chart_data_json = json.dumps(nuclear_generation_chart_data)


# --- HTML Template (Consolidated and all {{ }} for literals) ---
html_template_raw = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Natural Gas Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@latest/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {{font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #eef2f3; color: #333; line-height: 1.6;}}
        .container {{max-width: 960px; margin: 30px auto; background-color: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);}}
        h1 {{color: #2c3e50; text-align: center; margin-bottom: 30px; font-size: 2.5em; border-bottom: 3px solid #3498db; padding-bottom: 15px;}}
        h2 {{color: #34495e; font-size: 1.6em; margin-top: 0; margin-bottom: 25px; border-bottom: 1px solid #dae1e7; padding-bottom: 12px;}}
        .controls {{text-align: center; margin-bottom: 20px;}}
        .tab-buttons {{margin-top: 15px; display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;}}
        .tab-buttons button {{background-color: #3498db; color: white; border: none; padding: 14px 30px; border-radius: 10px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}}
        .tab-buttons button:hover {{background-color: #2980b9; transform: translateY(-2px);}}
        .tab-buttons button.active {{background-color: #2ecc71; box-shadow: 0 3px 8px rgba(46, 204, 113, 0.4);}}
        .tab {{display: none; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-top: 25px;}}
        .tab.active {{display: block;}}
        .summary-item {{background-color: #ecf0f1; padding: 12px 15px; border-radius: 6px; margin-bottom: 10px; border-left: 5px solid #3498db; display: flex; align-items: center; font-size: 1.05em;}}
        .summary-item strong {{color: #2c3e50; font-weight: 700; display: inline-block; min-width: 180px; margin-right: 10px;}}
        canvas {{background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 25px; width: 100% !important; height: 400px !important;}}
        .graph-controls {{text-align: center; margin-bottom: 25px;}}
        select {{padding: 12px; border-radius: 8px; border: 1px solid #bbb; font-size: 1.0em; min-width: 300px; margin-bottom: 15px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19.2c-5%200-9.6%202-13.6%206.4-4%204-6.4%209.6-6.4%2016.2%200%206.5%202.4%2012.2%206.4%2016.2l128%20127.9c4%204%209.6%206.4%2016.2%206.4s12.2-2.4%2016.2-6.4l128-127.9c4-4%206.4-9.6%206.4-16.2-.1-6.6-2.5-12.2-6.5-16.2z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 12px; padding-right: 30px;}}
        .chart-legend-toggles {{text-align: left; margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fcfcfc; display: flex; flex-wrap: wrap; gap: 15px;}}
        .chart-legend-toggles label {{display: flex; align-items: center; margin-right: 0; font-size: 0.95em; cursor: pointer; color: #555; transition: color 0.2s ease;}}
        .chart-legend-toggles label:hover {{color: #2c3e50;}}
        .chart-legend-toggles input[type="checkbox"] {{margin-right: 8px; transform: scale(1.1); cursor: pointer;}}
        .chart-legend-toggles .color-square {{display: inline-block; width: 14px; height: 14px; margin-right: 8px; border-radius: 4px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1);}}
        @media (max-width: 768px) {{
            .container {{margin: 10px; padding: 20px;}} h1 {{font-size: 2em;}} h2 {{font-size: 1.4em;}}
            .tab-buttons {{flex-direction: column; gap: 8px;}} .tab-buttons button {{width: 90%; margin: 0 auto; padding: 10px 20px;}}
            select {{min-width: unset; width: 90%;}} .chart-legend-toggles {{flex-direction: column; gap: 8px; padding: 10px;}}
            .summary-item strong {{min-width: 120px;}}
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>Natural Gas Dashboard</h1>
        <div class="controls">
            <div class="tab-buttons">
                <button id="report-tab-button" onclick="showTab('report')">üìÑ Report</button>
                <button id="storage-info-tab-button" onclick="showTab('storage-info')">üìä Storage Information</button>
                <button id="balance-tab-button" onclick="showTab('balance')">‚öôÔ∏è Balance Trends</button>
                <button id="daily-changes-tab-button" onclick="showTab('daily-changes')">üìà Daily Changes</button>
                <button id="nuclear-tab-button" onclick="showTab('nuclear')">‚ö° Nuclear Generation</button>
            </div>
        </div>
        <div id="report" class="tab">
            <h2>Market Report</h2>
            <div class="graph-controls" style="margin-top: 20px;">
                <label for="report-region-select">Select Region for Report:</label>
                <select id="report-region-select">
                    {region_options_html}
                </select>
            </div>
            <div id="report-content" class="summary">
                </div>
        </div>
        <div id="storage-info" class="tab">
            <div class="graph-controls" style="margin-top: 20px;">
                <label for="region-select">Select Region:</label>
                <select id="region-select">
                    <option value="">-- Choose Region --</option>
                    {region_options_html}
                </select>
            </div>
            <div class="graph-section">
                <h2>EIA Storage Graph</h2>
                <canvas id="chart"></canvas>
                <div id="chart-legend-toggles" class="chart-legend-toggles" style="display: none;">
                </div>
            </div>
            <div class="graph-section" style="margin-top: 40px;">
                <h2>Storage vs Henry Hub Price</h2>
                <canvas id="scatter-chart"></canvas>
            </div>
        </div>
        <div id="balance" class="tab">
            <h2>CONUS Balance: Historical vs Forecast</h2>
            <canvas id="balance-chart"></canvas>
        </div>
        <div id="daily-changes" class="tab">
            <h2>Daily Storage Changes by Storage Name</h2>
            <div class="graph-controls" style="margin-top: 20px;">
                <label for="daily-change-select">Select Storage Name:</label>
                <select id="daily-change-select">
                    <option value="">-- Choose Storage Name --</option>
                    {storage_name_options_html}
                </select>
            </div>
            <canvas id="daily-change-chart"></canvas>
        </div>
        <div id="nuclear" class="tab">
            <h2>U.S. Nuclear Generation Trend</h2>
            <canvas id="nuclear-chart"></canvas>
        </div>
    </div>
<script>
    const allRegionData = {region_outputs_json};
    const globalAvgTemp = "{avg_temp}"; 
    const globalAvgCDD = "{avg_cdd}"; 
    const globalAvgHDD = "{avg_hdd}"; 
    const defaultRegion = "{DEFAULT_REGION_DISPLAY_NAME}";

    const fundyChartData = {fundy_chart_data_json};
    const forecastChartData = {forecast_chart_data_json};
    const dailyChangeChartData = {daily_change_chart_data_json};
    const nuclearGenerationChartData = {nuclear_generation_chart_data_json};

    let myChart;
    let balanceChart;
    let scatterChart;
    let dailyChangeChart;
    let nuclearChart; // New chart variable

    function showTab(tabId) {{
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId + '-tab-button').classList.add('active');

        // Handle specific tab initializations
        if (tabId === 'storage-info') {{
            const storageRegionSelect = document.getElementById("region-select");
            const currentSelectedRegion = storageRegionSelect.value;
            if (currentSelectedRegion && currentSelectedRegion !== "") {{
                updateEIAStorageGraph(currentSelectedRegion);
                updateStoragePriceScatter(currentSelectedRegion);
            }} else {{
                // Clear existing charts if no region is selected
                if (myChart) {{ myChart.destroy(); myChart = null; }}
                if (scatterChart) {{ scatterChart.destroy(); scatterChart = null; }}
                document.getElementById("chart").getContext("2d").clearRect(0, 0, document.getElementById("chart").width, document.getElementById("chart").height);
                document.getElementById("scatter-chart").getContext("2d").clearRect(0, 0, document.getElementById("scatter-chart").width, document.getElementById("scatter-chart").height);
                document.getElementById("chart-legend-toggles").innerHTML = "<p><em>Select a region from the dropdown above to view its storage graphs.</em></p>";
                document.getElementById("chart-legend-toggles").style.display = 'block';
            }}
        }} else if (tabId === 'report') {{
            const reportRegionSelect = document.getElementById("report-region-select");
            // Ensure the report dropdown is set to the default or last selected value
            if (!reportRegionSelect.value) {{
                 reportRegionSelect.value = defaultRegion;
            }}
            updateReportContent(reportRegionSelect.value);
        }} else if (tabId === 'balance') {{
            updateBalanceChart();
        }} else if (tabId === 'daily-changes') {{
            const dailyChangeSelect = document.getElementById("daily-change-select");
            if (dailyChangeSelect.value) {{
                updateDailyChangeChart(dailyChangeSelect.value);
            }} else {{
                if (dailyChangeChart) {{ dailyChangeChart.destroy(); dailyChangeChart = null; }}
                document.getElementById("daily-change-chart").getContext("2d").clearRect(0, 0, document.getElementById("daily-change-chart").width, document.getElementById("daily-change-chart").height);
            }}
        }} else if (tabId === 'nuclear') {{ // New tab initialization for nuclear
            updateNuclearChart();
        }}

        // Destroy charts from other tabs if switching away
        if (tabId !== 'balance' && balanceChart) {{
            balanceChart.destroy();
            balanceChart = null;
        }}
        if (tabId !== 'storage-info') {{
            if (myChart) {{ myChart.destroy(); myChart = null; }}
            if (scatterChart) {{ scatterChart.destroy(); scatterChart = null; }}
            document.getElementById("chart-legend-toggles").innerHTML = "";
            document.getElementById("chart-legend-toggles").style.display = 'none';
        }}
        if (tabId !== 'daily-changes' && dailyChangeChart) {{
            dailyChangeChart.destroy();
            dailyChangeChart = null;
        }}
        if (tabId !== 'nuclear' && nuclearChart) {{ // Destroy nuclearChart
            nuclearChart.destroy();
            nuclearChart = null;
        }}
    }}

    function updateReportContent(selectedRegion) {{
        const reportContentDiv = document.getElementById("report-content");
        const report = allRegionData[selectedRegion] ? allRegionData[selectedRegion].report : null;

        if(report) {{
            reportContentDiv.innerHTML = `
                <div class="summary-item"><strong>Date:</strong> ${{report.latest_date}}</div>
                <div class="summary-item"><strong>Latest Price:</strong> ${{report.latest_price}}</div>
                <div class="summary-item"><strong>Avg US Temp (Last 7 Days):</strong> ${{globalAvgTemp}}</div>
                <div class="summary-item"><strong>Cooling Degree Days (7-day avg):</strong> ${{globalAvgCDD}}</div>
                <div class="summary-item"><strong>Heating Degree Days (7-day avg):</strong> ${{globalAvgHDD}}</div>
                <div class="summary-item"><strong>Current Storage ${{selectedRegion.includes("Lower 48") ? "(L48)" : "(Regional)"}}:</strong> ${{report.current_storage}} Bcf</div>
                <div class="summary-item"><strong>5-Year Avg ${{selectedRegion.includes("Lower 48") ? "(L48)" : "(Regional)"}}:</strong> ${{report.five_year_avg}} Bcf</div>
                <div class="summary-item"><strong>Storage Position ${{selectedRegion.includes("Lower 48") ? "(L48)" : "(Regional)"}}:</strong> ${{report.storage_position_label}}</div>
            `;
        }} else {{
            reportContentDiv.innerHTML = `<p><strong>No market report data available for ${{selectedRegion}}.</strong></p>`;
        }}
    }}

    const getWeekMonthLabels = () => {{
        const labels = [];
        const monthMap = ["Jan", "Jan", "Jan", "Jan", "Feb", "Feb", "Feb", "Feb", "Mar", "Mar", "Mar", "Mar", "Apr", "Apr", "Apr", "Apr", "May", "May", "May", "May", "Jun", "Jun", "Jun", "Jun", "Jun", "Jul", "Jul", "Jul", "Jul", "Aug", "Aug", "Aug", "Aug", "Sep", "Sep", "Sep", "Sep", "Oct", "Oct", "Oct", "Oct", "Nov", "Nov", "Nov", "Nov", "Dec", "Dec", "Dec", "Dec", "Dec", "Dec", "Dec"];
        for (let i = 1; i <= 53; i++) {{ labels.push(`${{i}} (${{monthMap[i - 1] || ''}})`); }}
        return labels;
    }};

    const colors = {{
        shaded_area: 'rgba(200, 200, 200, 0.3)', curr: "#2ecc71", price: "#9b59b6",
        proj_2020: "#8e44ad", proj_2021: "#3498db", proj_2022: "#1abc9c", proj_2023: "#f1c40f", proj_2024: "#e74c3c",
        year_2015: "#FFC300", year_2016: "#FF5733", year_2017: "#C70039", year_2018: "#900C3F", year_2019: "#581845",
        year_2020: "#009688", year_2021: "#4CAF50", year_2022: "#8BC34A", year_2023: "#CDDC39", year_2024: "#FFEB3B",
        scatter_points: '#3498db',
        log_fit_line: '#e74c3c' // Color for the logarithmic fit line
    }};

    function updateEIAStorageGraph(region_display_name) {{
        const regionDataKey = region_display_name;
        const chartCanvas = document.getElementById("chart");
        const chartTogglesDiv = document.getElementById("chart-legend-toggles");

        if (!regionDataKey || !(regionDataKey in allRegionData)) {{
            if (myChart) {{ myChart.destroy(); myChart = null; }}
            chartTogglesDiv.innerHTML = "<p><em>Select a valid region for storage graph.</em></p>";
            chartTogglesDiv.style.display = 'block'; return;
        }}

        const graphData = allRegionData[regionDataKey].graph;
        const labels = getWeekMonthLabels();

        const minData = graphData.map(d => d.min !== undefined ? d.min : null);
        const maxData = graphData.map(d => d.max !== undefined ? d.max : null);
        const years = [], projections = [];
        if (graphData.length > 0) {{ Object.keys(graphData[0]).forEach(key => {{ if (key.startsWith("year_")) years.push(key); if (key.startsWith("proj_")) projections.push(key); }}); }}

        const currentFullYear = new Date().getFullYear();
        const currYearKey = `year_${{currentFullYear}}`;
        const currYearData = graphData.map(d => d[currYearKey] !== undefined ? d[currYearKey] : null);
        let lastActualCurrYearWeek = currYearData.length - 1; while (lastActualCurrYearWeek >= 0 && currYearData[lastActualCurrYearWeek] === null) lastActualCurrYearWeek--;
        const trimmedCurrYearData = currYearData.slice(0, lastActualCurrYearWeek + 1);

        const projDatasets = projections.map(projKey => ({{ label: `Projection ${{projKey.replace("proj_", "")}} Scenario`, data: graphData.map(d => d[projKey] ?? null), borderColor: colors[projKey] || "#cccccc", borderDash: [5, 5], fill: false, hidden: (projKey !== 'proj_2022'), tension: 0.1, pointRadius: 2 }}));
        const historicalYearDatasets = years.filter(key => key !== currYearKey).map(yearKey => ({{ label: `Year ${{yearKey.replace("year_", "")}}`, data: graphData.map(d => d[yearKey] ?? null), borderColor: colors[yearKey] || "#cccccc", fill: false, hidden: false, tension: 0.1, pointRadius: 2 }}));
        const priceData = graphData.map(d => d.price ?? null);

        let yAxesConfig = {{ y_storage: {{ type: 'linear', display: true, position: 'left', title: {{ display: true, text: 'Storage (Bcf)', font: {{ size: 14, weight: 'bold' }} }}, ticks: {{ font: {{ size: 12 }} }}, grid: {{ color: '#e0e0e0' }} }} }};
        let priceAxisAdded = false;
        if (priceData.some(val => val !== null)) {{ yAxesConfig['y_price'] = {{ type: 'linear', display: true, position: 'right', title: {{ display: true, text: 'Price ($/MMBtu)', font: {{ size: 14, weight: 'bold' }} }}, grid: {{ drawOnChartArea: false }}, ticks: {{ font: {{ size: 12 }} }} }}; priceAxisAdded = true; }}

        const datasets = [
            {{ label: "Min Data (Internal)", data: minData, borderColor: 'transparent', backgroundColor: 'transparent', pointRadius: 0, pointHoverRadius: 0, fill: false, hidden: true, tension: 0.1, yAxisID: 'y_storage' }},
            {{ label: "Max Data (Internal)", data: maxData, borderColor: 'transparent', backgroundColor: colors.shaded_area, pointRadius: 0, pointHoverRadius: 0, fill: {{ target: '-1', above: colors.shaded_area, below: colors.shaded_area }}, hidden: true, tension: 0.1, yAxisID: 'y_storage' }},
            ...historicalYearDatasets, ...projDatasets,
            currYearKey ? {{ label: `Current Year (${{currentFullYear}})`, data: trimmedCurrYearData, borderColor: colors.curr, fill: false, borderWidth: 3, hidden: false, tension: 0.1, pointRadius: 3, pointBackgroundColor: colors.curr, yAxisID: 'y_storage' }} : null,
            priceAxisAdded ? {{ label: "Weekly Avg Price", data: priceData, borderColor: colors.price, fill: false, yAxisID: 'y_price', hidden: true, tension: 0.1, pointRadius: 2, pointBackgroundColor: colors.price }} : null
        ].filter(Boolean);

        if (myChart) {{ myChart.destroy(); }}
        myChart = new Chart(chartCanvas, {{
            type: 'line', data: {{ labels: labels, datasets: datasets }},
            options: {{ responsive: true, maintainAspectRatio: false, interaction: {{ mode: 'index', intersect: false }}, stacked: false,
                plugins: {{ legend: {{ display: false }}, title: {{ display: true, text: `${{regionDataKey}} Storage Trend`, font: {{ size: 18, weight: 'bold' }}, padding: {{ top: 10, bottom: 20 }} }},
                    tooltip: {{ mode: 'index', intersect: false, callbacks: {{
                        title: function(context) {{ return `Week ${{context[0].label.split(' ')[0]}}`; }},
                        label: function(context) {{ let label = context.dataset.label || ''; if (label) {{ label += ': '; }} if (context.parsed.y !== null) {{ label += context.parsed.y.toFixed(1) + (context.dataset.yAxisID === 'y_price' ? ' $' : ' Bcf'); }} return label; }}
                    }} }}
                }},
                scales: {{ x: {{ title: {{ display: true, text: 'Week of Year' }}, ticks: {{ autoSkip: false, maxRotation: 45, minRotation: 45, callback: function(val, index) {{ const weekNum = parseInt(this.getLabelForValue(val).split(' ')[0]); if (weekNum === 1 || weekNum === 13 || weekNum === 21 || weekNum === 38 || weekNum === 46 || weekNum === 53) {{ return labels[index].split('(')[1].replace(')', ''); }} else if (weekNum % 4 === 0) {{ return weekNum; }} return ''; }} }} }}, ...yAxesConfig }}
            }}
        }});

        let togglesHtml = '';
        myChart.data.datasets.forEach((ds, idx) => {{
            const color = ds.borderColor || '#000';
            if (ds.label && ds.label.includes("(Internal)")) return;
            if (ds.label) togglesHtml += `<label><span class="color-square" style="background:${{color}}"></span><input type="checkbox" data-dataset-index="${{idx}}" ${{myChart.isDatasetVisible(idx) ? 'checked' : ''}}> ${{ds.label}}</label>`;
        }});
        chartTogglesDiv.innerHTML = togglesHtml;
        chartTogglesDiv.style.display = 'flex'; chartTogglesDiv.style.marginTop = '20px';

        // Add event listeners to the new checkboxes for toggling visibility
        chartTogglesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {{
            checkbox.onchange = (e) => {{
                const index = e.target.dataset.datasetIndex;
                myChart.data.datasets[index].hidden = !e.target.checked;
                myChart.update();
            }};
        }});
    }}

    function updateStoragePriceScatter(region_display_name) {{
        const regionDataKey = region_display_name;
        const scatterCanvas = document.getElementById("scatter-chart");

        if (!regionDataKey || !(regionDataKey in allRegionData)) {{
            if (scatterChart) {{ scatterChart.destroy(); scatterChart = null; }}
            scatterCanvas.getContext("2d").clearRect(0, 0, scatterCanvas.width, scatterCanvas.height);
            return;
        }}

        const graphData = allRegionData[regionDataKey].graph;
        const logFitData = allRegionData[regionDataKey].log_fit; // Get the log fit data

        // Prepare data for scatter plot: {{ x: storage, y: price }}
        const scatterPoints = graphData.map(d => {{
            if (d.hasOwnProperty('Bcf') && d.hasOwnProperty('price') && d.Bcf !== null && d.price !== null) {{
                return {{ x: d.Bcf, y: d.price }};
            }}
            return null;
        }}).filter(Boolean); // Remove null entries

        if (scatterChart) {{ scatterChart.destroy(); }}
        scatterChart = new Chart(scatterCanvas, {{
            type: 'scatter',
            data: {{
                datasets: [
                    {{
                        label: `Historical Data`,
                        data: scatterPoints,
                        backgroundColor: colors.scatter_points,
                        borderColor: colors.scatter_points,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    }},
                    {{
                        type: 'line', // This is a line dataset
                        label: 'Logarithmic Line of Best Fit',
                        data: logFitData, // Use the log fit data here
                        borderColor: colors.log_fit_line,
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0, // No points for the line
                        tension: 0.1 // Smooth the line
                    }}
                ]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    title: {{
                        display: true,
                        text: `${{region_display_name}} Storage vs Henry Hub Price`,
                        font: {{ size: 18, weight: 'bold' }}
                    }},
                    tooltip: {{
                        callbacks: {{
                            label: function(context) {{
                                if (context.dataset.type === 'scatter') {{
                                    return `Storage: ${{context.parsed.x.toFixed(1)}} Bcf, Price: ${{context.parsed.y.toFixed(2)}} $`;
                                }} else {{ // For the line of best fit
                                    return `Fit (Storage: ${{context.parsed.x.toFixed(1)}} Bcf, Price: ${{context.parsed.y.toFixed(2)}} $)`;
                                }}
                            }}
                        }}
                    }}
                }},
                scales: {{
                    x: {{
                        type: 'linear',
                        position: 'bottom',
                        title: {{
                            display: true,
                            text: 'Storage Level (Bcf)',
                            font: {{ size: 14, weight: 'bold' }}
                        }},
                        ticks: {{ font: {{ size: 12 }} }}
                    }},
                    y: {{
                        type: 'linear',
                        position: 'left',
                        title: {{
                            display: true,
                            text: 'Henry Hub Weekly Avg Price ($/MMBtu)',
                            font: {{ size: 14, weight: 'bold' }}
                        }},
                        ticks: {{ font: {{ size: 12 }} }}
                    }}
                }}
            }}
        }});
    }}

    function updateBalanceChart() {{
        const ctx = document.getElementById("balance-chart").getContext("2d");
        if (balanceChart) balanceChart.destroy();
        balanceChart = new Chart(ctx, {{
            type: 'line',
            data: {{
                labels: fundyChartData.labels.concat(forecastChartData.labels),
                datasets: [
                    {{
                        label: "Historical CONUS Balance",
                        data: fundyChartData.values,
                        borderColor: "#2980b9",
                        backgroundColor: "rgba(41, 128, 185, 0.2)",
                        fill: false,
                        tension: 0.1,
                    }},
                    {{
                        label: "Forecasted CONUS Balance",
                        data: Array(fundyChartData.labels.length).fill(null).concat(forecastChartData.values),
                        borderColor: "#e67e22",
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                    }}
                ]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                interaction: {{ mode: 'index', intersect: false }},
                plugins: {{
                    title: {{
                        display: true,
                        text: 'CONUS Balance: Historical vs Forecast',
                        font: {{ size: 18, weight: 'bold' }}
                    }}
                }},
                scales: {{
                    y: {{
                        title: {{ display: true, text: 'Balance (Bcf)' }},
                        ticks: {{ font: {{ size: 12 }} }}
                    }},
                    x: {{
                        title: {{ display: true, text: 'Date' }},
                        ticks: {{ maxRotation: 45, minRotation: 45, font: {{ size: 11 }} }}
                    }}
                }}
            }}
        }});
    }}

    // New function for daily storage change chart
    function updateDailyChangeChart(selectedStorageName) {{
        const ctx = document.getElementById("daily-change-chart").getContext("2d");
        if (dailyChangeChart) dailyChangeChart.destroy();

        const data = dailyChangeChartData[selectedStorageName];

        if (!data) {{
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }}

        dailyChangeChart = new Chart(ctx, {{
            type: 'line',
            data: {{
                labels: data.dates,
                datasets: [{{
                    label: `Daily Storage Change for ${{selectedStorageName}}`,
                    data: data.values,
                    borderColor: '#17a2b8', // A new color for this chart
                    backgroundColor: 'rgba(23, 162, 184, 0.2)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 1 // Smaller points for dense data
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    title: {{
                        display: true,
                        text: `Daily Storage Change for ${{selectedStorageName}}`,
                        font: {{ size: 18, weight: 'bold' }}
                    }},
                    tooltip: {{
                        mode: 'index',
                        intersect: false,
                        callbacks: {{
                            label: function(context) {{
                                return `Change: ${{context.parsed.y.toFixed(2)}}`;
                            }}
                        }}
                    }}
                }},
                scales: {{
                    x: {{
                        type: 'time',
                        time: {{
                            unit: 'month',
                            tooltipFormat: 'MMM D,YYYY',
                            displayFormats: {{
                                month: 'MMM'
                            }}
                        }},
                        title: {{
                            display: true,
                            text: 'Effective Gas Day'
                        }},
                        ticks: {{
                            maxRotation: 45,
                            minRotation: 45
                        }}
                    }},
                    y: {{
                        title: {{
                            display: true,
                            text: 'Daily Storage Change'
                        }}
                    }}
                }}
            }}
        }});
    }}

    // New function for Nuclear Generation chart
    function updateNuclearChart() {{
        const ctx = document.getElementById("nuclear-chart").getContext("2d");
        if (nuclearChart) nuclearChart.destroy();

        if (!nuclearGenerationChartData || nuclearGenerationChartData.labels.length === 0) {{
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }}

        const datasets = [
            {{
                label: 'Total MW Generated',
                data: nuclearGenerationChartData.mw_values,
                borderColor: '#f39c12', // Orange color for MW
                backgroundColor: 'rgba(243, 156, 18, 0.2)',
                fill: false,
                tension: 0.1,
                yAxisID: 'y_mw'
            }}
        ];

        if (nuclearGenerationChartData.price_values && nuclearGenerationChartData.price_values.some(val => val !== null)) {{
            datasets.push({{
                label: 'Henry Hub Price ($/MMBtu)',
                data: nuclearGenerationChartData.price_values,
                borderColor: '#9b59b6', // Purple color for price (consistent with storage tab)
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.1,
                yAxisID: 'y_price'
            }});
        }}

        nuclearChart = new Chart(ctx, {{
            type: 'line',
            data: {{
                labels: nuclearGenerationChartData.labels,
                datasets: datasets
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                interaction: {{ mode: 'index', intersect: false }},
                plugins: {{
                    title: {{
                        display: true,
                        text: 'U.S. Nuclear Generation Trend & Henry Hub Price',
                        font: {{ size: 18, weight: 'bold' }}
                    }},
                    tooltip: {{
                        mode: 'index',
                        intersect: false,
                        callbacks: {{
                            label: function(context) {{
                                let label = context.dataset.label || '';
                                if (label) {{
                                    label += ': ';
                                }}
                                if (context.parsed.y !== null) {{
                                    label += context.parsed.y.toFixed(2);
                                    if (context.dataset.yAxisID === 'y_mw') {{
                                        label += ' MW';
                                    }} else if (context.dataset.yAxisID === 'y_price') {{
                                        label += ' $';
                                    }}
                                }}
                                return label;
                            }}
                        }}
                    }}
                }},
                scales: {{
                    x: {{
                        type: 'time',
                        time: {{
                            unit: 'month',
                            tooltipFormat: 'MMM D,YYYY',
                            displayFormats: {{
                                month: 'MMM'
                            }}
                        }},
                        title: {{
                            display: true,
                            text: 'Date'
                        }},
                        ticks: {{
                            maxRotation: 45,
                            minRotation: 45
                        }}
                    }},
                    y_mw: {{
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {{
                            display: true,
                            text: 'Total MW Generated',
                            font: {{ size: 14, weight: 'bold' }}
                        }},
                        grid: {{
                            color: '#e0e0e0'
                        }}
                    }},
                    y_price: {{
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {{
                            display: true,
                            text: 'Henry Hub Price ($/MMBtu)',
                            font: {{ size: 14, weight: 'bold' }}
                        }},
                        grid: {{
                            drawOnChartArea: false // Only draw grid lines for the left axis
                        }}
                    }}
                }}
            }}
        }});
    }}

    document.addEventListener("DOMContentLoaded", function() {{
        const storageRegionSelect = document.getElementById("region-select");
        storageRegionSelect.value = ""; // Ensures "Choose Region" is displayed for storage tab

        const reportRegionSelect = document.getElementById("report-region-select");
        reportRegionSelect.value = defaultRegion; // Set default region for the report tab
        
        // Add event listener for the NEW report region select
        reportRegionSelect.addEventListener("change", function() {{
            updateReportContent(this.value);
        }});

        // Existing event listener for storage tab dropdown (kept separate for clarity)
        document.getElementById("region-select").addEventListener("change", function() {{
            const selectedRegion = this.value;
            const currentActiveTab = document.querySelector('.tab.active');
            if (currentActiveTab && currentActiveTab.id === 'storage-info') {{
                if (selectedRegion && selectedRegion !== "") {{
                    updateEIAStorageGraph(selectedRegion);
                }} else {{
                    if (myChart) {{ myChart.destroy(); myChart = null; }}
                    if (scatterChart) {{ scatterChart.destroy(); scatterChart = null; }}
                    document.getElementById("chart").getContext("2d").clearRect(0, 0, document.getElementById("chart").width, document.getElementById("chart").height);
                    document.getElementById("scatter-chart").getContext("2d").clearRect(0, 0, document.getElementById("scatter-chart").width, document.getElementById("scatter-chart").height);
                    document.getElementById("chart-legend-toggles").innerHTML = "<p><em>Select a region from the dropdown above to view its storage graphs.</em></p>";
                    document.getElementById("chart-legend-toggles").style.display = 'block';
                }}
            }}
        }});

        // Add event listener for the new daily change dropdown
        document.getElementById("daily-change-select").addEventListener("change", function() {{
            const selectedStorageName = this.value;
            const currentActiveTab = document.querySelector('.tab.active');
            if (currentActiveTab && currentActiveTab.id === 'daily-changes') {{
                if (selectedStorageName) {{
                    updateDailyChangeChart(selectedStorageName);
                }} else {{
                    if (dailyChangeChart) {{ dailyChangeChart.destroy(); dailyChangeChart = null; }}
                    document.getElementById("daily-change-chart").getContext("2d").clearRect(0, 0, document.getElementById("daily-change-chart").width, document.getElementById("daily-change-chart").height);
                }}
            }}
        }});

        showTab('report'); // Show report tab by default
    }});
</script>
</body>
</html>
"""

# --- Generate and Open HTML Report ---
try:
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html_template_raw)
    print(f"\n‚úÖ HTML report successfully generated at: {output_path}")
    webbrowser.open(f"file:///{output_path}")
except Exception as e:
    print(f"‚ùå Failed to write HTML report: {e}")